library(Matrix)
library(stringr)

# RT Barcodes - all barcodes are of length 10
RT_Barcodes<-read.table("/gale/netapp/home/jswift/analysis/CI_1001/Identifiers/sc_RT_plate.txt",header=TRUE, sep="\t")
RT_Barcode<-NA
for (i in 1:384) {RT_Barcode[i]<-substring(as.character(RT_Barcodes[i,4]),22,31)}
RT_Barcodes[,5]<-RT_Barcode 

# LIG Barcodes - some LIG barcodes are 9 bp, others are 10bp
LIG_Barcodes<-read.table("/gale/netapp/home/jswift/analysis/CI_1001/Identifiers/sc_ligation_plate.txt",header=TRUE, sep="\t")
LIG_Barcode<-NA
for (i in 1:384) {if (nchar(as.character(LIG_Barcodes[i,4])) == 53) {LIG_Barcode[i]<-substring(as.character(LIG_Barcodes[i,4]),44,53)} 
                  if (nchar(as.character(LIG_Barcodes[i,4])) == 51) {LIG_Barcode[i]<-substring(as.character(LIG_Barcodes[i,4]),43,51)}}
LIG_Barcodes[,5]<-LIG_Barcode

### Generate Matrix
generate_matrix<-function(gene_count_folder){
  gene_matrix <- paste(gene_count_folder, "/count.MM", sep = "")
  df_gene <- paste(gene_count_folder, "/gene_name_annotate.txt", sep = "")
  df_cell <- paste(gene_count_folder, "/cell_annotate.txt", sep = "")

  # this is your entire gene list    
  df_gene <- read.csv(df_gene, header = F) 
  rownames(df_gene) <- df_gene$gene_id
  colnames(df_gene) <- c("gene_id", "gene_type", "exon_intron", "gene_name", "index")
  
  # this is your entire detected index list
  df_cell <- read.csv(df_cell, header = F)
  colnames(df_cell) <- c("sample", "index")
  rownames(df_cell) <- df_cell$sample 
  
  # this is your condensed matrix of counts
  gene_matrix <- read.csv(gene_matrix, header = F)
  colnames(gene_matrix)<- c("gene_name","index","count")
  remove<-c("nothing","nothing_intron")
  gene_matrix<-gene_matrix[!gene_matrix[,1] %in% remove, ]
  
  full_names<-as.character(gene_matrix$gene_name)
  full_genes<-NA
  for(i in 1:length(full_names)){full_genes[i] <- substring(full_names[i],1,9)}
  gene_matrix[,1]<-as.factor(full_genes)
  gene_matrix<-gene_matrix[order(gene_matrix[,1], decreasing = FALSE),]
  gene_matrix[,4]<-gene_matrix[,1]
  gene_matrix[,1]<-as.numeric(gene_matrix$gene_name)
  colnames(gene_matrix)<-c("gene_identifier","index","count","gene_name")
  
  # generate your sparse matrix
  gene_count <- sparseMatrix(i = gene_matrix$gene_identifier, j = gene_matrix$index, x = gene_matrix$count)
  colnames(gene_count) <- rownames(df_cell) # which infact, these align with your df_cell
  rownames(gene_count) <- unique(gene_matrix$gene_name) # each row is in order of the gene 'identifier' which is in gene alphabetical order 
  gene_count}

arabidopsis_matrix_lists<-list(NA)
for (i in 1:16) {arabidopsis_matrix_lists[[i]] <- generate_matrix(gene_count_folder=paste("/gale/netapp/home/jswift/analysis/CI_Drought/D2D3_leaf/combo_indexing_run_D2D3/split_",i,"/Arabidopsis_gene_count",sep=''))}
for (i in 17:37) {arabidopsis_matrix_lists[[i]] <- generate_matrix(gene_count_folder=paste("/gale/netapp/home/jswift/analysis/CI_Drought/D1D4_leaf/combo_indexing_run_D1D4/split_",(i-16),"/Arabidopsis_gene_count",sep=''))}
for (i in 38:66) {arabidopsis_matrix_lists[[i]] <- generate_matrix(gene_count_folder=paste("/gale/netapp/home/jswift/analysis/CI_Drought/D5D6_leaf/combo_indexing_run_D5D6/split_",(i-37),"/Arabidopsis_gene_count",sep=''))}
for (i in 67:94) {arabidopsis_matrix_lists[[i]] <- generate_matrix(gene_count_folder=paste("/gale/netapp/home/jswift/analysis/CI_Drought/D9D0_leaf/combo_indexing_run_D9D0/split_",(i-66),"/Arabidopsis_gene_count",sep=''))}
for (i in 95:120) {arabidopsis_matrix_lists[[i]] <- generate_matrix(gene_count_folder=paste("/gale/netapp/home/jswift/analysis/CI_Drought/D7D8_leaf/combo_indexing_run_D7D8/split_",(i-94),"/Arabidopsis_gene_count",sep=''))}

print('no. nuclei/combinations in each split (this is raw count; before low count removal)')
for (i in 1:120) {print(length(arabidopsis_matrix_lists[[i]][1,]))}

# Make Rows All The Same
all_gene_names <- NA
for (i in 1:120) {all_gene_names <- c(all_gene_names, rownames(arabidopsis_matrix_lists[[i]]))}
all_gene_names <- all_gene_names[-1]
all_gene_names <- unique(all_gene_names)

adding_missing_genes<-function(input_matrix){
  missing_genes<-setdiff(all_gene_names,rownames(input_matrix))
  filler_matrix<-matrix(0,nrow=length(missing_genes),ncol=length(colnames(input_matrix)))
  rownames(filler_matrix)<-missing_genes
  colnames(filler_matrix)<-colnames(input_matrix)
  output<-rbind(input_matrix,filler_matrix)
  output<-output[all_gene_names,]
  output}

arabidopsis_matrix_lists_sized<-list(NA)
for (i in 1:120) {arabidopsis_matrix_lists_sized[[i]] <- adding_missing_genes(arabidopsis_matrix_lists[[i]])}

save(arabidopsis_matrix_lists_sized, file = "arabidopsis_matrix_lists_sized.RData")

# Rename Column Names
RT_Identifier_D2D3<-read.table("/gale/ddn/ddn_neomorph/jswift/analysis/R_CI/text_files/D2_D3_RT_Identifier.txt",header=TRUE, sep="\t")
RT_Identifier_D1D4<-read.table("/gale/ddn/ddn_neomorph/jswift/analysis/R_CI/text_files/D1_D4_RT_Identifier.txt",header=TRUE, sep="\t") 
RT_Identifier_D5D6<-read.table("/gale/ddn/ddn_neomorph/jswift/analysis/R_CI/text_files/D5_D6_RT_Identifier.txt",header=TRUE, sep="\t") 
RT_Identifier_D9D0<-read.table("/gale/ddn/ddn_neomorph/jswift/analysis/R_CI/text_files/D9_D0_RT_Identifier.txt",header=TRUE, sep="\t") 
RT_Identifier_D7D8<-read.table("/gale/ddn/ddn_neomorph/jswift/analysis/R_CI/text_files/D7_D8_RT_Identifier.txt",header=TRUE, sep="\t") 

get_new_identifiers<-function(input_matrix, identifier){

  # get PCR well and barcode name
  PCR_list<-""
  barcode_list<-""
  LIG_list<-""
  RT_list<-""
  fullnames<-colnames(input_matrix)
  
  # Call Barcodes
  for(i in 1:length(fullnames))
    {fullname <- fullnames[i]
     
     # PCR Barcode
     PCRwell <- tolower(fullname) 
     PCRwell <- substring(PCRwell, str_locate(PCRwell, "_combo_index")[1]-3 , str_locate(PCRwell, "_combo_index")[1]-1 )
     PCRwell <- str_remove(PCRwell, "1_") 
     PCRwell <- str_remove(PCRwell, "[_]") 
     PCR_list <- c(PCR_list, PCRwell)
     
     # Barcode
     barcode <- substring(fullname,nchar(fullname)-19,nchar(fullname)) 
     barcode <- str_remove(barcode, "[.]") # some barcodes are 19 and some are 20
     barcode_list <- c(barcode_list, barcode)
     
     # LIG Barcode
     if (nchar(barcode) == 20) Ligation_name<-as.character(LIG_Barcodes[LIG_Barcodes[,5] %in% substr(barcode,1,10),1])
     if (nchar(barcode) == 19) Ligation_name<-as.character(LIG_Barcodes[LIG_Barcodes[,5] %in% substr(barcode,1,9),1])
     LIG_list<- c(LIG_list,Ligation_name)
     
     # RT Barcode
     if (nchar(barcode) == 20) RT_name<-as.character(RT_Barcodes[RT_Barcodes[,5] %in% substr(barcode,11,20),1])
     if (nchar(barcode) == 19) RT_name<-as.character(RT_Barcodes[RT_Barcodes[,5] %in% substr(barcode,10,19),1])
     RT_list<- c(RT_list,RT_name)
     }
  
  barcode_list<-barcode_list[-1]
  PCR_list<-PCR_list[-1]
  PCR_list<-gsub("_", "", PCR_list)
  LIG_list<-LIG_list[-1]
  RT_list<-RT_list[-1]
  RT_numeric<-as.numeric(str_remove_all(RT_list, "[sc_ligation_RT_]"))
  LIG_numeric<-as.numeric(str_remove_all(LIG_list, "[sc_ligation_]"))

  
  # Rename RT with leaf sample
  RT_name<-NA
  for (i in 1:length(RT_numeric)) {RT_name[i] <- identifier[ RT_numeric[i] ,8] }
  
  # Rename PCR, LIG and RT 
  PCR_name<-paste('PCR',PCR_list,sep='_')
  LIG_name<-paste('LIG',LIG_numeric,sep='_')
  RT_name_2<-paste('RT',RT_numeric,sep='_')
  
  cell_identifier<-paste(RT_name, PCR_name, LIG_name, RT_name_2,sep='_')
  cell_identifier}

for (i in 1:16) {colnames(arabidopsis_matrix_lists_sized[[i]]) <- get_new_identifiers(arabidopsis_matrix_lists_sized[[i]], RT_Identifier_D2D3)}
for (i in 17:37) {colnames(arabidopsis_matrix_lists_sized[[i]]) <- get_new_identifiers(arabidopsis_matrix_lists_sized[[i]], RT_Identifier_D1D4)}
for (i in 38:66) {colnames(arabidopsis_matrix_lists_sized[[i]]) <- get_new_identifiers(arabidopsis_matrix_lists_sized[[i]], RT_Identifier_D5D6)}
for (i in 67:94) {colnames(arabidopsis_matrix_lists_sized[[i]]) <- get_new_identifiers(arabidopsis_matrix_lists_sized[[i]], RT_Identifier_D9D0)}
for (i in 95:120) {colnames(arabidopsis_matrix_lists_sized[[i]]) <- get_new_identifiers(arabidopsis_matrix_lists_sized[[i]], RT_Identifier_D7D8)}

# Remove Control Wells
arabidopsis_matrix_lists_clean<-list(NA)
for (i in 1:120) {arabidopsis_matrix_lists_clean[[i]] <- arabidopsis_matrix_lists_sized[[i]][, ((substring(colnames(arabidopsis_matrix_lists_sized[[i]]),5,5)) == 'W' |  (substring(colnames(arabidopsis_matrix_lists_sized[[i]]),5,5)) == 'D' )]}

# Checking no duplicate names
all_well_names <- NA
for (i in 1:120) {all_well_names <- c(all_well_names, colnames(arabidopsis_matrix_lists_clean[[i]]))}

print('checking that resubsetting by leaf type doesnt use duplicate names (last number should be zero)')
length(all_well_names)
length(unique(all_well_names))
all_well_names[duplicated(all_well_names)]

# Re-Subsetting 
full_matrix <- matrix(NA,nrow=length(all_gene_names),ncol=1)

for (i in 1:120) {full_matrix <- cbind(full_matrix, arabidopsis_matrix_lists_clean[[i]]) }
full_matrix<-full_matrix[,-1]

# full matrix dimensions
print('fully merged CI matrix dimensions')
dim(full_matrix)

save(full_matrix, file = "L1_plant_combined_rosette_rep1_demultiplex.RData")
