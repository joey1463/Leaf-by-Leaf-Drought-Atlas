# Read in Conditions Table
setwd("~/Desktop/Salk/Project - Hormones and Drought/R Files")
load(paste("L1_conditions_rosette_3-way.RData",sep=''))
Conditions$normalized_age<-23 + Conditions$real_time - (Conditions$development * 2) 
load("plant_combined_average_expression.RData")

setwd("~/Desktop/Salk/Project - Hormones and Drought/R Files")
chosen_cluster<-'L3_epidermis'
chosen_cluster<-'L3_phloem'
chosen_cluster<-'L3_mesophyll'
chosen_cluster<-'L3_xylem'
chosen_cluster<-'L3_bundle_sheath'
chosen_cluster<-'L3_guard'

load(paste(paste(chosen_cluster, sep="", collapse=""),"_multivariate_list_rosette.RData",sep=''))
cut_off<-0.01 
fold_change_upregulated<- 0.04 
fold_change_downregulated<- -0.04 
Two_Model_Output_Sig<-Multivariate_List[[1]]
Two_Model_Output_Sig$Treatment_FC<- Two_Model_Output_Sig$Treatment_FC*-1 # reverse
Development_Output_Sig<-Multivariate_List[[2]]


# Venn Diagram - Up regulated
Development_Upregulated<-rownames(subset(Development_Output_Sig, Development_Output_Sig$padj<cut_off & Development_Output_Sig$log2FoldChange>fold_change_upregulated))
Two_Model_Upregulated<-subset(Two_Model_Output_Sig,Two_Model_Output_Sig$Development_p<cut_off & Two_Model_Output_Sig$Treatment_p<cut_off & Two_Model_Output_Sig$Development_FC > fold_change_upregulated)
Two_Model_Upregulated_Drought_Down<-rownames(subset(Two_Model_Upregulated, Two_Model_Upregulated$Treatment_FC<0))
Two_Model_Upregulated_Drought_Up<-rownames(subset(Two_Model_Upregulated, Two_Model_Upregulated$Treatment_FC>0))
Venn_List_Up<- list( Dev_Up = c(Development_Upregulated, Two_Model_Upregulated_Drought_Down,Two_Model_Upregulated_Drought_Up),
                     Drought_Down = Two_Model_Upregulated_Drought_Down,
                     Drought_Up = Two_Model_Upregulated_Drought_Up)
plot(euler(Venn_List_Up, shape = "ellipse"), quantities = TRUE)
length(c(Development_Upregulated, Two_Model_Upregulated_Drought_Down,Two_Model_Upregulated_Drought_Up)) # total

# Venn Diagram - Down regulated
Development_Downregulated<-rownames(subset(Development_Output_Sig, Development_Output_Sig$padj<cut_off & Development_Output_Sig$log2FoldChange<fold_change_downregulated))
Two_Model_Downregulated<-subset(Two_Model_Output_Sig,Two_Model_Output_Sig$Development_p<cut_off & Two_Model_Output_Sig$Treatment_p<cut_off & Two_Model_Output_Sig$Development_FC < fold_change_downregulated)
Two_Model_Downregulated_Drought_Down<-rownames(subset(Two_Model_Downregulated, Two_Model_Downregulated$Treatment_FC<0))
Two_Model_Downregulated_Drought_Up<-rownames(subset(Two_Model_Downregulated, Two_Model_Downregulated$Treatment_FC>0))
Venn_List_Down<- list( Dev_Down = c(Development_Downregulated, Two_Model_Downregulated_Drought_Down,Two_Model_Downregulated_Drought_Up),
                       Drought_Down = Two_Model_Downregulated_Drought_Down,
                       Drought_Up = Two_Model_Downregulated_Drought_Up)
plot(euler(Venn_List_Down, shape = "ellipse"), quantities = TRUE)
length(c(Development_Downregulated, Two_Model_Downregulated_Drought_Down,Two_Model_Downregulated_Drought_Up)) #total

#  Z-score Plot
drought_plot<-function(drought_test_genes, cell_type_call){
drought_test_genes_1<-subset(plant_combined_average_expression, rownames(plant_combined_average_expression) %in% drought_test_genes)
Z <- as.data.frame(t(scale(t(drought_test_genes_1))))
Z_average<-colSums(Z)/length(Z[,1])
Z<-rbind(Z, Z_average)
rownames(Z)[length(Z[,1])]<-"average"
plot_matrix<-melt(t(Z))
factored<-as.character(plot_matrix[,1])
time<-substr(factored,1,3)
time<-str_remove(time, "D") 
time<-as.numeric(str_remove(time, "_"))
plot_matrix[,4]<-time
cell_type<-substr(factored,11,40)
plot_matrix[,5]<-cell_type
plot_matrix[,6]<-as.numeric(plot_matrix[,2] == 'average')
colnames(plot_matrix)<-c("sample","gene","expression","time","cell_type","color")
plot_matrix<-subset(plot_matrix, plot_matrix$gene %in% c('average'))
plot_matrix[,1]<-substr(as.character(plot_matrix[,1]),1,9)
plot_matrix<-merge(plot_matrix, Conditions, by.x='sample',by.y='row.names') # some go missing?
plot_matrix<-subset(plot_matrix, plot_matrix$treatment %in% unique(plot_matrix$treatment)[c(1,6,9)])
plot_matrix<-subset(plot_matrix, plot_matrix$cell_type == cell_type_call)
title<-paste(dim(drought_test_genes_1)[1],"genes",sep=" ")
ggplot(data=plot_matrix, aes(x=normalized_age, y=expression, group=as.factor(treatment))) + geom_smooth(method = "loess", se=TRUE, level=0.95, aes(fill=as.factor(treatment), color=as.factor(treatment))) +  theme_bw() + theme(axis.text=element_text(size=15)) +
   xlab("") + ylab("") + scale_color_manual(values=c('red3',"grey70",'blue4'))  + scale_fill_manual(values=c('red3',"grey70",'blue4'))   + theme(legend.position = "none") + labs(title=title)}  
  
drought_plot(Two_Model_Downregulated_Drought_Down, "mesophyll")
drought_plot(Two_Model_Upregulated_Drought_Up, "mesophyll")

drought_plot(Two_Model_Downregulated_Drought_Down, "epidermis")
drought_plot(Two_Model_Upregulated_Drought_Up, "epidermis")

# Plotting Individual Genes
drought_plot<-function(drought_test_genes, cell_type_call, y_min, y_max){
drought_test_genes_1<-subset(plant_combined_average_expression, rownames(plant_combined_average_expression) %in% drought_test_genes)

plot_matrix<-as.data.frame(t(drought_test_genes_1))
plot_matrix[,2]<-colnames(plot_matrix)[1]
plot_matrix[,3]<-rownames(plot_matrix)
plot_matrix<-plot_matrix[,c(3,2,1)]

factored<-as.character(plot_matrix[,1])
time<-substr(factored,1,3)
time<-str_remove(time, "D") 
time<-as.numeric(str_remove(time, "_"))
plot_matrix[,4]<-time
cell_type<-substr(factored,11,40)
plot_matrix[,5]<-cell_type
#plot_matrix[,6]<-as.numeric(plot_matrix[,2] == 'average')
colnames(plot_matrix)<-c("sample","gene","expression","time","cell_type")
#plot_matrix<-subset(plot_matrix, plot_matrix$gene %in% c('average'))
plot_matrix[,1]<-substr(as.character(plot_matrix[,1]),1,9)
plot_matrix<-merge(plot_matrix, Conditions, by.x='sample',by.y='row.names') # some go missing?
plot_matrix<-subset(plot_matrix, plot_matrix$treatment %in% unique(plot_matrix$treatment)[c(1,8,9)]) # using last 2 days (day 7 and 8) for drought
plot_matrix$treatment<-as.integer(plot_matrix$treatment)
#plot_matrix<-subset(plot_matrix, plot_matrix$time ==8)
plot_matrix<-subset(plot_matrix, plot_matrix$cell_type == cell_type_call)

ggplot(data=plot_matrix, aes(x=normalized_age, y=expression, group=as.factor(treatment))) + geom_smooth(method = "gam", se=TRUE, level=0.95,  formula = y ~ poly(x, 3), aes(fill=as.factor(treatment), color=as.factor(treatment))) + geom_point(size=1,aes(color=as.factor(treatment))) + theme_bw() + theme(axis.text=element_text(size=15)) + xlab("") + ylab("") + scale_color_manual(values=c('red3','blue4'))  + scale_fill_manual(values=c('red3','blue4')) + theme(legend.position = "none") + ylim(c(y_min,y_max)) 

}

# Figure 2
drought_plot("AT1G19270", "mesophyll", 0, 0.7) #DA1
drought_plot("AT4G39400", "mesophyll", 0, 4.5) #BRI1 

drought_plot("AT5G52310", "epidermis",0.01, 30) # RD29A
drought_plot("AT4G38970", "epidermis",0,40) # Fructose bisphosphate


# MESOPHYLL LEAF DEVELOPMENT MARKERS
drought_plot("AT1G14920", "mesophyll", 0, 1) #GAI
drought_plot("AT5G57660", "mesophyll", 1, 6.5) #COL5
drought_plot("AT5G08070", "mesophyll", 0, 0.12) #TCP17
drought_plot("AT4G30290", "mesophyll", 0, 0.1) #XTH19
drought_plot("AT5G47500", "mesophyll", 0, 4) #PME5
drought_plot("AT5G18010", "mesophyll", 0, 0.05) #SAUR19

# EPIDERMIS LEAF DEVELOPMENT MARKERS 
drought_plot("AT1G26770", "epidermis", 0, 3) #EXP10

# PHLOEM LEAF DEVELOPMENT MARKERS 
drought_plot("AT1G15690", "phloem", 0, 6) #AVP1
drought_plot("AT1G26770", "phloem", 0, 2) #EXP10

# mesophyll cell cycle markers
i<-"AT2G38620" #CDKB1;2
drought_plot("AT5G67260", "mesophyll", 0, 0.6) #CYCD3;2
drought_plot("AT1G02970", "mesophyll", 0, 0.15) #WEE1
drought_plot("AT1G15570", "mesophyll", 0, 0.4) #CYCA2;3

# epidermal cell cycle markers
drought_plot("AT2G38620", "epidermis", 0, 0.2) #CDKB1;2
drought_plot("AT2G27960", "epidermis", 0, 1) #CKS1

# Photosynthesis associated gene markers
drought_plot("AT1G67090", "mesophyll", 0, 160) #RBCS1A
drought_plot("AT1G29930", "mesophyll", 0, 160) #CAB1
drought_plot("AT1G03130", "mesophyll", 0, 15) #PSAD-2 photosystem
