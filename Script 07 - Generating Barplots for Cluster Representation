# This script will generate UMAPS for each experiment and report a normalized barplot of cluster representation

library(Seurat)
require(ggplot2)
require(reshape2)
load("L1_plant_combined.RData")

# Plot Cluster
pdf("UMAP_full.pdf",width=9, height=9)
DimPlot(object = plant_combined, reduction = "umap", label = TRUE, raster = FALSE)  + NoLegend()
dev.off()

### Rosette UMAP (Well Watered)
  plant_combined_rosette<-plant_combined[,plant_combined$experiment_type %in% c('rosette')]
  plant_combined_rosette$leaf_treatment <-substring(colnames(plant_combined_rosette),5,5)
  plant_combined_rosette_watered<-plant_combined_rosette[,plant_combined_rosette$leaf_treatment %in% c('W')]
  pdf("UMAP_rosette_watered.pdf")
  DimPlot(object = plant_combined_rosette_watered, reduction = "umap", raster=FALSE, label = TRUE)
  dev.off()
  plant_combined_rosette_watered$leaf_number<-substring(colnames(plant_combined_rosette_watered),7,9)
  raw_table<-table(as.character(plant_combined_rosette_watered@active.ident), plant_combined_rosette_watered$leaf_number) # leaf number

### Rosette UMAP (Drought)
  plant_combined_rosette_drought<-plant_combined_rosette[,plant_combined_rosette$leaf_treatment %in% c('D')]
  pdf("UMAP_rosette_drought.pdf")
  DimPlot(object = plant_combined_rosette_drought, reduction = "umap", raster=FALSE, label = TRUE)
  dev.off()
  plant_combined_rosette_drought$leaf_number<-substring(colnames(plant_combined_rosette_drought),7,9)
  raw_table<-table(as.character(plant_combined_rosette_drought@active.ident), plant_combined_rosette_drought$leaf_number) # leaf number

### Seedling UMAP
  plant_combined_seedling<-plant_combined[,plant_combined$experiment_type %in% c('seedling')]
  pdf("UMAP_seedling.pdf")
  DimPlot(object = plant_combined_seedling, reduction = "umap", raster=FALSE, label = TRUE)
  dev.off()
  plant_combined_seedling$seedling_time<-substring(colnames(plant_combined_seedling),1,3)
  raw_table<-table(as.character(plant_combined_seedling@active.ident), plant_combined_seedling$seedling_time)


### Hormone UMAP
  plant_combined_hormone<-plant_combined[,plant_combined$experiment_type %in% c('hormone')]
  pdf("UMAP_hormone.pdf")
  DimPlot(object = plant_combined_hormone, reduction = "umap", raster=FALSE, label = TRUE)
  dev.off()
  plant_combined_hormone$hormone<-plant_combined_hormone$Day
  raw_table<-table(as.character(plant_combined_hormone@active.ident), plant_combined_hormone$hormone)

  
  
### Run Barplot
  normalized_table<-matrix(NA,nrow=length(raw_table[,1]),ncol=length(raw_table[1,]))
  rownames(normalized_table)<-rownames(raw_table)
  colnames(normalized_table)<-colnames(raw_table)
  for (i in 1:length(raw_table[1,])) {normalized_table[,i]<-as.numeric(raw_table[,i]/sum(raw_table[,i]))}
  
  normalized_table_1<-melt(normalized_table)
  colnames(normalized_table_1)<-c("cluster","day","value")
  normalized_table_1[,1]<-as.factor(normalized_table_1[,1])
  
  b1 <- ggplot(normalized_table_1, aes(fill=cluster, y=value, x=day)) + geom_bar(position="stack", stat="identity")
  b2 <- b1 + labs(x = "") + labs(y = "") +  theme_bw() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
  b3 <- b2 + theme(axis.text=element_text(size=12),axis.title=element_text(size=12)) 
  
  pdf("leaf_raw_table_hormone.pdf")
  b3
  dev.off()
