library(Seurat)
library(DESeq2)

Call_2way_model<-function(subcluster_plant_combined_rosette, chosen_cluster, read_cutoff){

    subcluster_plant_combined_rosette<-subcluster_plant_combined_rosette[,substr(colnames(subcluster_plant_combined_rosette),11,13) %in% c("R01","R02","R03")] 
    subcluster_plant_combined_rosette$leaf_identity<-substr(colnames(subcluster_plant_combined_rosette),1,9)
    Idents(subcluster_plant_combined_rosette) <-subcluster_plant_combined_rosette$leaf_identity
    pseudobulk<-AggregateExpression(object = subcluster_plant_combined_rosette, slot = "counts", group.by = "leaf_identity")
    pseudobulk<-as.data.frame(pseudobulk[[1]])
    pseudobulk<-pseudobulk[,as.numeric(substr(colnames(pseudobulk),2,3)) %in% c(0:8)] # remove re-water control
    
    maxes<-rowSums(pseudobulk)
    pseudobulk<-pseudobulk[ maxes > read_cutoff,] 
    remove<-c("D07_D_L11","D01_W_L04") # removing libraries that did not pass QC in xylem and guard respectively
    pseudobulk<-pseudobulk[, !colnames(pseudobulk) %in% remove]
    pseudobulk<-pseudobulk[, colSums(pseudobulk)>750] # nessesary for xylem, which has low read counts
    
    # Define Factors
    factor_list<-colnames(pseudobulk)
    Background<-rownames(pseudobulk)
    Conditions<-data.frame(development=as.numeric(substr(factor_list,8,9)),real_time=as.numeric(substr(factor_list,2,3)),treatment=substr(factor_list,5,5), row.names = colnames(pseudobulk))
    
    # Incorporating Drought Factor 
    pot_total_weights<-log(c(100, 89.9, 82.2, 69, 59.4, 48.3, 38.1, 28.8, 21.7, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100),2)
    drought_quantitative<-NA
    for (i in 1:length(Conditions[,1])) { if (Conditions[i,3] == "W") {drought_quantitative[i] <- pot_total_weights[1]}
                                          if (Conditions[i,3] == "D") {if (substr(rownames(Conditions)[i],1,3) == 'D00') {drought_quantitative[i] <- pot_total_weights[1]}
                                                                       if (substr(rownames(Conditions)[i],1,3) == 'D01') {drought_quantitative[i] <- pot_total_weights[2]}
                                                                       if (substr(rownames(Conditions)[i],1,3) == 'D02') {drought_quantitative[i] <- pot_total_weights[3]}
                                                                       if (substr(rownames(Conditions)[i],1,3) == 'D03') {drought_quantitative[i] <- pot_total_weights[4]}
                                                                       if (substr(rownames(Conditions)[i],1,3) == 'D04') {drought_quantitative[i] <- pot_total_weights[5]}
                                                                       if (substr(rownames(Conditions)[i],1,3) == 'D05') {drought_quantitative[i] <- pot_total_weights[6]}
                                                                       if (substr(rownames(Conditions)[i],1,3) == 'D06') {drought_quantitative[i] <- pot_total_weights[7]}
                                                                       if (substr(rownames(Conditions)[i],1,3) == 'D07') {drought_quantitative[i] <- pot_total_weights[8]}
                                                                       if (substr(rownames(Conditions)[i],1,3) == 'D08') {drought_quantitative[i] <- pot_total_weights[9]}}}
    Conditions[,3]<-drought_quantitative

    #Conditions$age_quantitative<- ((Conditions$real_time/2) - Conditions$development) + 11.5 original, delete me
    Conditions$age_quantitative<- 23 + Conditions$real_time - (Conditions$development * 2) 

    colnames(Conditions)<-c("development","real_time","treatment","normalized_age")

    # pseudo-bulk on 3-way
    DEmat<-DESeq(DESeqDataSetFromMatrix(countData = pseudobulk,colData = Conditions, design = ~ development + real_time + treatment)) 
    pseudo_bulk_normalized_three_way<- counts(estimateSizeFactors(DEmat), normalized=TRUE)
   
    # Run Statistic
    cut_off<-0.01
    
    # Treatment + Age
    DEmat<-DESeq(DESeqDataSetFromMatrix(countData = pseudobulk,colData = Conditions, design = ~ normalized_age + treatment)) 
    pseudo_bulk_normalized<- counts(estimateSizeFactors(DEmat), normalized=TRUE)
    barplot(colSums(pseudo_bulk_normalized[,rownames(Conditions[order(Conditions$normalized_age),])])) # order by age
    Two_Model_Output<-as.data.frame(cbind(results(DESeq(DEmat, test='LRT', reduced = ~ treatment))[,c(2,6)], # development
                                          results(DESeq(DEmat, test='LRT', reduced = ~ normalized_age))[,c(2,6)])) # treatment
    colnames(Two_Model_Output)<-c('Development_FC','Development_p','Treatment_FC','Treatment_p')
    rownames(Two_Model_Output)<-rownames(pseudo_bulk_normalized) 
    
    # Age
    DEmat<-DESeq(DESeqDataSetFromMatrix(countData = pseudobulk,colData = Conditions, design = ~ normalized_age)) 
    Development_Output<-results(DESeq(DEmat, test='LRT', reduced = ~ 1))[,c(2,6)]
    
    # Treatment
    DEmat<-DESeq(DESeqDataSetFromMatrix(countData = pseudobulk,colData = Conditions, design = ~ treatment)) 
    Treatment_Output<-results(DESeq(DEmat, test='LRT', reduced = ~ 1))[,c(2,6)]
        
    # change fold-changes to corrected values
    Two_Model_Output$Development_FC<-Development_Output$log2FoldChange
    Two_Model_Output$Treatment_FC<-Treatment_Output$log2FoldChange
    
    Two_Model_Output[is.na(Two_Model_Output)] <- 1
    Two_Model_Output_Sig<-subset(Two_Model_Output, Two_Model_Output$Development_p<cut_off & Two_Model_Output$Treatment_p<cut_off)
    Two_Model_Output_Not_Sig<-subset(Two_Model_Output, Two_Model_Output$Development_p>=cut_off | Two_Model_Output$Treatment_p>=cut_off)
    Two_Model_Output_Not_Sig_Development_Leaning<-subset(Two_Model_Output_Not_Sig, Two_Model_Output_Not_Sig$Development_p < Two_Model_Output_Not_Sig$Treatment_p)
    Two_Model_Output_Not_Sig_Drought_Leaning<-subset(Two_Model_Output_Not_Sig, Two_Model_Output_Not_Sig$Development_p > Two_Model_Output_Not_Sig$Treatment_p)

    Development_Output_Sig<-subset(Development_Output, Development_Output$padj<cut_off)
    Development_Output_Sig<- Development_Output_Sig[!(rownames(Development_Output_Sig) %in% rownames(Two_Model_Output_Sig)), ]
    Development_Output_Sig<-subset(Development_Output_Sig, rownames(Development_Output_Sig) %in% rownames(Two_Model_Output_Not_Sig_Development_Leaning))
  
    Treatment_Output_Sig<- subset(Treatment_Output, Treatment_Output$padj<cut_off)
    Treatment_Output_Sig<- Treatment_Output_Sig[!(rownames(Treatment_Output_Sig) %in% rownames(Two_Model_Output_Sig)), ]
    Treatment_Output_Sig<- subset(Treatment_Output_Sig, rownames(Treatment_Output_Sig) %in% rownames(Two_Model_Output_Not_Sig_Drought_Leaning))

    Multivariate_List<-list(Two_Model_Output_Sig, Development_Output_Sig, Treatment_Output_Sig)
    
    save(Multivariate_List, file = paste('L3',paste(chosen_cluster, sep="", collapse=""),"multivariate_list_rosette.RData",sep='_'))
    save(pseudo_bulk_normalized, file = paste('L3',paste(chosen_cluster, sep="", collapse=""),"pseudo_bulk_normalized_rosette.RData",sep='_'))
    save(pseudo_bulk_normalized_three_way, file = paste('L3',paste(chosen_cluster, sep="", collapse=""),"pseudo_bulk_normalized_rosette_three_way.RData",sep='_'))
    save(Two_Model_Output, file = paste('L3',paste(chosen_cluster, sep="", collapse=""),"two_model_output_rosette_2-way.RData",sep='_'))
    }

# Xylem 
load("L3_xylem_subcluster_rosette.RData")
Call_2way_model(subcluster_plant_combined_rosette, chosen_cluster = "xylem", read_cutoff = 256) 

# Whole Epidermis
load("L3_whole_epidermis_subcluster_rosette.RData")
Call_2way_model(subcluster_plant_combined_rosette, chosen_cluster = "whole_epidermis", read_cutoff = 256) 

# Whole Vasculature
load("L3_whole_vasculature_subcluster_rosette.RData")
Call_2way_model(subcluster_plant_combined_rosette, chosen_cluster = "whole_vasculature", read_cutoff = 256) 

# Mesophyll
load("L3_mesophyll_subcluster_rosette.RData")
Call_2way_model(subcluster_plant_combined_rosette, chosen_cluster = "mesophyll", read_cutoff = 256) 

# Phloem
load("L3_phloem_subcluster_rosette.RData")
Call_2way_model(subcluster_plant_combined_rosette, chosen_cluster = "phloem", read_cutoff = 256) 

# Bundle Sheath
load("L3_bundle_sheath_subcluster_rosette.RData")
Call_2way_model(subcluster_plant_combined_rosette, chosen_cluster = "bundle_sheath", read_cutoff = 256) 

# Guard
load("L3_guard_subcluster_rosette.RData")
Call_2way_model(subcluster_plant_combined_rosette, chosen_cluster = "guard", read_cutoff = 256) 

# Epidermis
load("L3_epidermis_subcluster_rosette.RData")
Call_2way_model(subcluster_plant_combined_rosette, chosen_cluster = "epidermis", read_cutoff = 256)
